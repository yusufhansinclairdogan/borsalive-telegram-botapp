<!doctype html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Takas • Borsa Live</title>
    <style>
        :root {
            --bg: #0c1218;
            --panel: #141b22cc;
            --panel-solid: #141b22;
            --muted: #a8b2be;
            --text: #eaf0f8;
            --line: #35424d88;
            --green: #22c55e;
            --red: #ef4444;
            --amber: #f59e0b;
            --blur: 12px;
            --r: 18px;
            --chip1: #1b2a3a;
            --chip2: #243246;
            --chip3: #123b2c;
            --chip4: #3a2a1b;
            --chip5: #2a1b3a;
            --menu-h: 64px;
            /* alt menü yüksekliği */
        }

        [data-theme="light"] {
            --bg: #f3f5f8;
            --panel: #ffffffcc;
            --panel-solid: #fff;
            --muted: #5a6b7c;
            --text: #0f1720;
            --line: #d8e0e8;
            --chip1: #eef5ff;
            --chip2: #f7f2ff;
            --chip3: #e8fff5;
            --chip4: #fff3e6;
            --chip5: #f9ecff;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1200px 800px at 80% -10%, #1b2734 0%, #0f1620 40%, var(--bg) 70%) fixed;
            color: var(--text);
            font: 15.5px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial;
        }

        [data-theme="light"] body {
            background: #f6f8fb
        }

        /* Watermark now on top */
        .wm {
            position: fixed;
            inset: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(-24deg);
            opacity: .18;
            letter-spacing: .5px;
            text-align: center;
            font-weight: 900;
            font-size: 48px;
            color: #ffffff;
            z-index: 9999;
            mix-blend-mode: luminosity;
        }

        [data-theme="light"] .wm {
            color: #0f1720;
            opacity: .16;
            mix-blend-mode: multiply;
        }

        .wm small {
            display: block;
            font-weight: 700;
            font-size: 24px;
            margin-top: 6px
        }

        .wrap {
            max-width: 1200px;
            margin: 22px auto calc(140px + var(--menu-h));
            padding: 0 16px;
            position: relative;
            z-index: 1
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: var(--r);
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            padding: 14px
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap
        }

        .symbol {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .symbol img {
            width: 40px;
            height: 40px;
            border-radius: 10px
        }

        .symtxt {
            font-size: 24px;
            font-weight: 800
        }

        .badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center
        }

        .badge {
            padding: 8px 10px;
            border-radius: 10px;
            background: #0f1620;
            border: 1px solid #2a3541;
            font-weight: 800
        }

        [data-theme="light"] .badge {
            background: #fff;
            border-color: #d8e0e8
        }

        .badge.up {
            color: var(--green)
        }

        .badge.down {
            color: var(--red)
        }

        .muted {
            color: var(--muted);
            font-size: 12px
        }

        .btn {
            border-radius: 12px;
            padding: 10px 14px;
            border: 1px solid #2a3541;
            background: #17202b;
            color: var(--text);
            cursor: pointer;
            font-weight: 800;
            transform: translateZ(0);
            transition: transform .12s ease, box-shadow .12s ease
        }

        .btn:hover {
            transform: translateY(-1px)
        }

        .btn:active {
            transform: translateY(0)
        }

        .btn.primary {
            background: #1a2430;
            border-color: #425262
        }

        .btn.ghost {
            background: transparent
        }

        [data-theme="light"] .btn {
            background: #fff;
            border-color: #d8e0e8
        }

        /* Drawer menu */
        .drawer {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 60
        }

        .drawer.open {
            display: block
        }

        .drawer .backdrop {
            position: absolute;
            inset: 0;
            background: #0007;
            animation: fade .22s ease
        }

        .drawer .panel {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: min(86vw, 360px);
            background: rgba(20, 27, 34, .92);
            border-right: 1px solid var(--line);
            backdrop-filter: blur(20px);
            padding: 18px;
            transform: translateX(-6%);
            animation: slide .25s ease forwards
        }

        [data-theme="light"] .drawer .panel {
            background: #ffffffee;
            color: var(--text)
        }

        @keyframes fade {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes slide {
            to {
                transform: translateX(0)
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800
        }

        .logo img {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            object-fit: cover
        }

        .menu-items {
            margin-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .menu-item {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid transparent;
            cursor: pointer;
            display: flex;
            gap: 10px;
            color: var(--text);
            text-decoration: none
        }

        .menu-item:hover {
            background: #ffffff10;
            border-color: #ffffff18
        }

        [data-theme="light"] .menu-item:hover {
            background: #00000008;
            border-color: #00000010
        }

        .menu-footer {
            position: absolute;
            left: 18px;
            right: 18px;
            bottom: 18px;
            color: var(--muted);
            font-size: 12px
        }

        .themebtn {
            margin-top: 6px
        }

        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr auto auto;
            gap: 10px;
            margin-top: 10px
        }

        @media (max-width:1000px) {
            .filters {
                grid-template-columns: 1fr 1fr 1fr
            }
        }

        @media (max-width:700px) {
            .filters {
                grid-template-columns: 1fr 1fr
            }
        }

        .fld {
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative
        }

        .fld label {
            font-size: 12px;
            color: var(--muted)
        }

        .fld input,
        .fld button {
            width: 100%;
            background: #0f1620;
            border: 1px solid #2a3541;
            color: var(--text);
            border-radius: 12px;
            padding: 10px 12px;
            outline: none
        }

        [data-theme="light"] .fld input,
        [data-theme="light"] .fld button {
            background: #fff;
            border-color: #d8e0e8
        }

        .fld input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) opacity(.8)
        }

        [data-theme="light"] .fld input[type="date"]::-webkit-calendar-picker-indicator {
            filter: none
        }

        .actions {
            display: flex;
            gap: 8px;
            align-items: end
        }

        .star {
            position: absolute;
            right: 8px;
            top: 34px;
            color: #f59e0b
        }

        /* Suggest */
        #suggest {
            position: absolute;
            left: 0;
            top: 70px;
            right: 0;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 12px;
            display: none;
            max-height: 260px;
            overflow: auto;
            z-index: 80
        }

        /* Summary (Takas Özeti) */
        .summary-card {
            margin-top: 12px
        }

        .sum-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }

        .sum-title {
            font-weight: 800
        }

        .sum-row {
            display: flex;
            gap: 10px;
            overflow: auto;
            padding-bottom: 8px;
            scroll-snap-type: x mandatory
        }

        .chip {
            flex: 0 0 auto;
            min-width: 180px;
            scroll-snap-align: start;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid var(--line);
            background: var(--panel-solid)
        }

        .chip h4 {
            margin: 0 0 6px 0;
            font-size: 12px;
            color: var(--muted)
        }

        .chip .v {
            font-size: 16px;
            font-weight: 800
        }

        .chip.c1 {
            background: linear-gradient(0deg, var(--chip1), transparent)
        }

        .chip.c2 {
            background: linear-gradient(0deg, var(--chip2), transparent)
        }

        .chip.c3 {
            background: linear-gradient(0deg, var(--chip3), transparent)
        }

        .chip.c4 {
            background: linear-gradient(0deg, var(--chip4), transparent)
        }

        .chip.c5 {
            background: linear-gradient(0deg, var(--chip5), transparent)
        }

        /* Table */
        .table-card {
            margin-top: 12px
        }

        .table-scroll {
            position: relative;
            overflow: auto;
            border-radius: 14px
        }

        .scroll-hint::after {
            content: "» Kaydır »";
            position: absolute;
            top: 8px;
            right: 12px;
            font-weight: 800;
            font-size: 12px;
            color: #ffffffcc;
            padding: 6px 10px;
            border-radius: 999px;
            background: #00000050;
            animation: slidehint 1.2s ease-in-out infinite;
            pointer-events: none;
        }

        [data-theme="light"] .scroll-hint::after {
            color: #0f1720;
            background: #00000014
        }

        @keyframes slidehint {
            0% {
                transform: translateX(0)
            }

            50% {
                transform: translateX(8px)
            }

            100% {
                transform: translateX(0)
            }
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            min-width: 760px
        }

        thead th {
            position: sticky;
            top: 0;
            background: #0f1620;
            color: var(--muted);
            padding: 10px 12px;
            border-bottom: 1px solid #203040;
            text-align: left;
            cursor: pointer;
            user-select: none
        }

        [data-theme="light"] thead th {
            background: #f7f9fc;
            border-color: #e7edf4
        }

        tbody td {
            padding: 10px 12px;
            border-bottom: 1px solid #1d2732
        }

        [data-theme="light"] tbody td {
            border-color: #eef2f6
        }

        tbody tr:nth-child(2n) {
            background: #101925
        }

        [data-theme="light"] tbody tr:nth-child(2n) {
            background: #ffffff
        }

        tbody tr.hl {
            outline: 2px solid var(--amber);
            background: #1f2833
        }

        .right {
            text-align: right
        }

        /* Pagination (sticky above bottom menu) */
        .pager {
            position: sticky;
            bottom: calc(var(--menu-h) + 10px);
            z-index: 40;
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .pager .pbox {
            display: flex;
            gap: 8px;
            align-items: center;
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 8px 10px;
        }

        .page-btn {
            border: 1px solid var(--line);
            background: transparent;
            color: var(--text);
            padding: 6px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
        }

        .page-btn[disabled] {
            opacity: .5;
            cursor: not-allowed
        }

        .page-ind {
            font-weight: 800;
            min-width: 90px;
            text-align: center
        }

        /* Bottom nav (more polished) */
        .bnav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--menu-h);
            z-index: 70;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            align-items: center;
            padding: 10px 14px;
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            background: var(--panel);
            border-top: 1px solid var(--line);
        }

        .bitem {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--text);
            font-weight: 700;
            text-decoration: none;
            border-radius: 14px;
            padding: 6px 8px;
            transition: transform .12s ease, background .12s ease;
        }

        .bitem:hover {
            transform: translateY(-1px);
            background: #ffffff10
        }

        [data-theme="light"] .bitem:hover {
            background: #0000000a
        }

        /* Toast + Modal */
        .toast {
            position: fixed;
            right: 18px;
            bottom: calc(var(--menu-h) + 24px);
            z-index: 80;
            padding: 12px 14px;
            border-radius: 12px;
            background: #1f2a36;
            border: 1px solid #394756;
            color: #fff;
            display: none
        }

        .toast.show {
            display: block
        }

        .modal {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 80
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center
        }

        .modal .back {
            position: absolute;
            inset: 0;
            background: #0008
        }

        .modal .box {
            position: relative;
            min-width: min(92vw, 720px);
            background: var(--panel-solid);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 18px;
            z-index: 1
        }

        .modal .head {
            font-weight: 800;
            margin-bottom: 8px
        }

        .modal .body {
            max-height: 60vh;
            overflow: auto;
            color: var(--text);
            line-height: 1.6
        }

        .modal .foot {
            margin-top: 14px;
            display: flex;
            justify-content: flex-end
        }
    </style>
</head>

<body>
    <div class="wm">Borsa Live App <small>By Yusufhan Doğan</small></div>

    <!-- Drawer -->
    <div id="drawer" class="drawer" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="panel">
            <div class="logo">
                <img src="/borsalive/app/static/borsalivelogo.jpg" alt="logo" />
                <div>Borsa Live</div>
            </div>
            <div class="menu-items">
                <a class="menu-item" id="go-depth">📊 <span>Derinlik</span></a>
                <a class="menu-item" id="go-akd">🧩 <span>Aracı Kurum Dağılımı</span></a>
                <a class="menu-item" id="go-takas">📑 <span>Takas</span></a>
                <button class="menu-item themebtn" id="themeSwitch">🌓 <span>Koyu/Açık Tema</span></button>
            </div>
            <div class="menu-footer">Borsa Live — App By Yusufhan Doğan © 2025</div>
        </div>
    </div>

    <div class="wrap">
        <div class="card">
            <div class="header">
                <div class="symbol">
                    <img id="logo" src="" alt="">
                    <div>
                        <div class="symtxt" id="symText">—</div>
                        <div class="muted" id="asOf">—</div>
                    </div>
                </div>
                <div class="badges">
                    <div id="lastBadge" class="badge">Son: —</div>
                    <div id="chgBadge" class="badge">—</div>
                    <button class="btn" id="btnMenu">☰ Menü</button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <div class="fld">
                    <label>Sembol</label>
                    <input id="sym" placeholder="ASELS" autocomplete="off">
                    <div class="star">⭐</div>
                    <div id="suggest"></div>
                </div>
                <div class="fld">
                    <label>Başlangıç Tarihi</label>
                    <input type="date" id="dStart">
                </div>
                <div class="fld">
                    <label>Bitiş Tarihi</label>
                    <input type="date" id="dEnd">
                </div>
                <div class="actions">
                    <button id="btnApply" class="btn primary">🔎 Uygula</button>
                    <button id="btnToday" class="btn ghost">🔄 Bugün</button>
                </div>
                <div class="actions">
                    <button id="btnWarn" class="btn">⚠️ Uyarı</button>
                </div>
            </div>
        </div>

        <!-- Takas Özeti -->
        <div class="card summary-card">
            <div class="sum-head">
                <div class="sum-title">Takas Özeti</div>
                <div class="muted" id="sumTime">—</div>
            </div>
            <div id="sumRow" class="sum-row">
                <!-- JS dolduracak -->
            </div>
        </div>

        <!-- Table -->
        <div class="card table-card">
            <h3 style="margin:0 0 10px 0">Takas Detay</h3>
            <div class="muted" id="sumInfo">—</div>
            <div id="tableScroll" class="table-scroll scroll-hint">
                <table id="tbl">
                    <thead>
                        <tr>
                            <th data-k="agent">Aracı Kurum</th>
                            <th class="right" data-k="quantity">Takas</th>
                            <th class="right" data-k="volume">Tutar</th>
                            <th class="right" data-k="t1_quantity">Dün Lot</th>
                            <th class="right" data-k="t0_quantity">Gün Lot</th>
                            <th class="right" data-k="cost">Maliyet</th>
                            <th class="right" data-k="pct">% </th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pager">
                <div class="pbox">
                    <button id="btnFirst" class="page-btn">« İlk</button>
                    <button id="btnPrev" class="page-btn">‹ Önceki</button>
                    <div id="pageInd" class="page-ind">Sayfa 1/1</div>
                    <button id="btnNext" class="page-btn">Sonraki ›</button>
                    <button id="btnLast" class="page-btn">Son »</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bnav" aria-label="Alt menü">
        <a class="bitem" id="chipMenu" role="button" aria-label="Menü aç">
            <div>☰</div><small>Menü</small>
        </a>
        <a class="bitem" id="chipHome" href="/" aria-label="Ana sayfa">
            <div>🏠</div><small>Ana Sayfa</small>
        </a>
        <a class="bitem" id="chipInfo" role="button" aria-label="Bilgi">
            <div>ℹ️</div><small>Bilgi</small>
        </a>
    </nav>

    <!-- Toast -->
    <div id="toast" class="toast">Hisse sembol adı yanlış</div>

    <!-- Modal -->
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mhead">
        <div class="back" data-close></div>
        <div class="box">
            <div id="mhead" class="head">Uyarı</div>
            <div id="mtext" class="body">
                <div style="font-size:44px;text-align:center;margin:8px 0">⚠️</div>
                MKK'dan menkul kıymet bazında ve TAKASBANK'tan fon bazında alınan saklama bakiyelerine ait veriler
                tekrar yayınlanamaz...
                (metnin kalanını burada tamamlayabilirsin)
            </div>
            <div class="foot"><button id="mok" class="btn primary">Tamam</button></div>
        </div>
    </div>

    <script>
        /* ===== State & helpers ===== */
        const qs = s => document.querySelector(s), qsa = s => Array.from(document.querySelectorAll(s));
        const state = {
            apiBase: "{{ api_base }}",
            webBase: "{{ webapp_base }}",
            symbol: "{{ symbol }}",
            data: null,
            rows: [],
            sortKey: "agent",
            sortDir: 1,
            market: { last: null, chg: null, chgPct: null },
            theme: localStorage.getItem("akd-theme") || "dark",
            allSymbols: [],
            pageSize: 10,
            page: 1,
        };
        document.documentElement.setAttribute("data-theme", state.theme);

        function todayISO() { return new Date().toISOString().slice(0, 10); }
        function fmtQty(n) { if (n == null) return "—"; n = Number(n) || 0; return n.toLocaleString("tr-TR"); }
        function fmtNum(n, p = 2) { if (n == null || isNaN(n)) return "—"; return Number(n).toLocaleString("tr-TR", { minimumFractionDigits: p, maximumFractionDigits: p }); }
        function showToast(msg) { const t = qs("#toast"); t.textContent = msg; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 2000); }
        function showModal(msg) { if (msg) qs("#mtext").innerHTML = msg; qs("#modal").classList.add("show"); }
        qs("#mok").onclick = () => qs("#modal").classList.remove("show");

        /* ===== Menu / nav / theme ===== */
        const drawer = qs("#drawer"); function openDrawer() { drawer.classList.add("open"); } function closeDrawer() { drawer.classList.remove("open"); }
        qs("#btnMenu").onclick = openDrawer; qs("#chipMenu").onclick = openDrawer;
        drawer.addEventListener("click", e => { if (e.target.matches("[data-close]")) closeDrawer(); });
        qs("#themeSwitch").onclick = () => { state.theme = (state.theme === "dark" ? "light" : "dark"); document.documentElement.setAttribute("data-theme", state.theme); localStorage.setItem("akd-theme", state.theme); };
        qs("#go-depth").onclick = () => location.href = `${state.webBase}/webapp/depth?symbol=${encodeURIComponent(state.symbol)}`;
        qs("#go-akd").onclick = () => location.href = `${state.webBase}/webapp/akd?symbol=${encodeURIComponent(state.symbol)}`;
        qs("#go-takas").onclick = closeDrawer;

        /* ===== Sticky hint remove when scrolled ===== */
        const tScroll = qs("#tableScroll");
        let hintTimeout = setTimeout(() => tScroll.classList.remove("scroll-hint"), 3500);
        tScroll.addEventListener("scroll", () => tScroll.classList.remove("scroll-hint"), { once: true });

        /* ===== Autocomplete from /api/sectoral-brief ===== */
        const input = qs("#sym"), suggest = qs("#suggest");
        async function loadSymbols() {
            try {
                const r = await fetch(`${state.apiBase}/api/sectoral-brief`);
                if (!r.ok) return;
                const arr = await r.json(); const set = new Set();
                (arr || []).forEach(x => {
                    const s = x.symbol || x.code || x.sym || x.ticker || x.name || x.s || null;
                    if (s && /^[A-Z0-9]{3,6}$/.test(s)) set.add(String(s).toUpperCase());
                });
                state.allSymbols = [...set];
            } catch { }
        }
        function renderSuggest(list) {
            if (!list.length) { suggest.style.display = "none"; suggest.innerHTML = ""; return; }
            suggest.innerHTML = list.slice(0, 60).map(s => `<div data-s="${s}" style="padding:8px 10px;cursor:pointer;border-bottom:1px solid #1c2430">${s}</div>`).join("");
            suggest.style.display = "block";
        }
        input.addEventListener("input", () => {
            const v = input.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
            if (!v) { renderSuggest([]); return; }
            const m = state.allSymbols.filter(s => s.includes(v)).sort((a, b) => a.indexOf(v) - b.indexOf(v));
            renderSuggest(m);
        });
        suggest.addEventListener("click", e => { const d = e.target.closest("[data-s]"); if (!d) return; input.value = d.dataset.s; suggest.style.display = "none"; });
        document.addEventListener("click", e => { if (!suggest.contains(e.target) && e.target !== input) suggest.style.display = "none"; });

        /* ===== Market WS ===== */
        let mws;
        function connectMarket(sym) {
            if (mws) try { mws.close(); } catch { }
            mws = new WebSocket(`${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws/market/${encodeURIComponent(sym)}`);
            mws.onmessage = ev => {
                try {
                    const b = atob(ev.data);
                    const u8 = new Uint8Array(b.length); for (let i = 0; i < b.length; i++) u8[i] = b.charCodeAt(i);
                    function v(u8, i) { let x = 0, s = 0, ii = i; while (true) { const b = u8[ii++]; x |= (b & 0x7f) << s; if (!(b & 0x80)) break; s += 7; } return [x, ii]; }
                    function f64(u8, i) { const dv = new DataView(u8.buffer, u8.byteOffset); const val = dv.getFloat64(i, true); return [val, i + 8]; }
                    let i = 0, L = u8.length, m = {};
                    while (i < L) {
                        let t;[t, i] = v(u8, i); const f = t >> 3, wt = t & 7;
                        if (wt === 1) { let val;[val, i] = f64(u8, i); m[f] = val; }
                        else if (wt === 0) { let val;[val, i] = v(u8, i); m[f] = val; }
                        else if (wt === 2) { let ln;[ln, i] = v(u8, i); i += ln; }
                        else if (wt === 5) { i += 4; } else break;
                    }
                    const last = m[5] ?? m[25]; const bid = m[10] ?? m[42];
                    if (last != null && bid != null) {
                        const diff = last - bid, pct = bid ? diff / bid * 100 : null;
                        state.market = { last, chg: diff, chgPct: pct };
                        renderHeader();
                    }
                } catch { }
            };
        }
        function renderHeader() {
            qs("#lastBadge").textContent = state.market.last != null ? `Son: ${fmtNum(state.market.last, 2)}` : "Son: —";
            const chgEl = qs("#chgBadge");
            if (state.market.chg == null) { chgEl.textContent = "—"; chgEl.className = "badge"; return; }
            const sign = state.market.chg >= 0 ? "up" : "down";
            chgEl.className = "badge " + sign;
            chgEl.textContent = `${fmtNum(state.market.chg, 2)} (${fmtNum(state.market.chgPct, 2)}%)`;
        }

        /* ===== TAKAS fetch ===== */
        function buildParams() {
            const dS = qs("#dStart").value || todayISO();
            const dE = qs("#dEnd").value || todayISO();
            const p = new URLSearchParams({ symbol: state.symbol, start: dS, end: dE });
            return p.toString();
        }
        async function fetchTakas() {
            const r = await fetch(`${state.apiBase}/api/takas?${buildParams()}`);
            if (!r.ok) { showToast("Veri alınamadı veya yetki hatası"); return null; }
            const js = await r.json();
            const obj = Array.isArray(js) ? js[js.length - 1] : js;
            return obj;
        }

        /* ===== Summary render ===== */
        function renderSummary(obj) {
            const row = qs("#sumRow"); row.innerHTML = "";
            const chips = [
                { k: "totalQuantity", t: "Toplam Lot", cls: "c1", val: fmtQty(obj.totalQuantity) },
                { k: "totalVolume", t: "Toplam Tutar", cls: "c2", val: fmtNum(obj.totalVolume, 2) },
                { k: "totalVolumeUSD", t: "USD Tutar", cls: "c3", val: fmtNum(obj.totalVolumeUSD, 2) },
                { k: "totalVolumeEUR", t: "EUR Tutar", cls: "c4", val: fmtNum(obj.totalVolumeEUR, 2) },
                { k: "close", t: "Kapanış", cls: "c5", val: fmtNum(obj.close, 2) },
            ];
            for (const c of chips) {
                const el = document.createElement("div");
                el.className = `chip ${c.cls}`;
                el.innerHTML = `<h4>${c.t}</h4><div class="v">${c.val}</div>`;
                row.appendChild(el);
            }
            qs("#sumTime").textContent = `Saat: ${obj.time || "—"}`;
        }

        /* ===== Table render + pagination ===== */
        function mapRows(obj) {
            const total = Number(obj.totalQuantity || 0) || 0;
            const arr = (obj.agentQuantities || []).map(x => {
                const pct = total ? (Number(x.quantity || 0) / total * 100) : null;
                return {
                    agent: x.agent,
                    quantity: Number(x.quantity || 0),
                    volume: Number(x.volume || 0),
                    t1_quantity: Number(x.t1_quantity || 0),
                    t0_quantity: Number(x.t0_quantity || 0),
                    cost: Number(x.cost || 0),
                    pct: pct
                };
            });
            return arr;
        }
        function sortRows() {
            const k = state.sortKey, dir = state.sortDir;
            state.rows.sort((a, b) => {
                const va = a[k], vb = b[k];
                if (typeof va === "string" || typeof vb === "string") {
                    return String(va).localeCompare(String(vb), "tr") * dir;
                }
                return ((va || 0) - (vb || 0)) * dir;
            });
        }
        function renderPage() {
            sortRows();
            const tb = qs("#tbody"); tb.innerHTML = "";
            const totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize));
            if (state.page > totalPages) state.page = totalPages;
            const start = (state.page - 1) * state.pageSize;
            const slice = state.rows.slice(start, start + state.pageSize);
            slice.forEach(r => {
                const tr = document.createElement("tr"); tr.dataset.agent = r.agent;
                tr.innerHTML = `
      <td>${r.agent}</td>
      <td class="right">${fmtQty(r.quantity)}</td>
      <td class="right">${fmtNum(r.volume, 2)}</td>
      <td class="right">${fmtQty(r.t1_quantity)}</td>
      <td class="right">${fmtQty(r.t0_quantity)}</td>
      <td class="right">${fmtNum(r.cost, 2)}</td>
      <td class="right">${fmtNum(r.pct, 2)}</td>`;
                tb.appendChild(tr);
            });
            // pager state
            qs("#pageInd").textContent = `Sayfa ${state.page}/${totalPages}`;
            qs("#btnFirst").disabled = qs("#btnPrev").disabled = (state.page <= 1);
            qs("#btnLast").disabled = qs("#btnNext").disabled = (state.page >= totalPages);
        }
        qsa("#tbl thead th").forEach(th => {
            th.addEventListener("click", () => {
                const k = th.dataset.k; if (!k) return;
                if (state.sortKey === k) { state.sortDir *= -1; } else { state.sortKey = k; state.sortDir = 1; }
                state.page = 1; renderPage();
            });
        });
        // pager actions
        qs("#btnFirst").onclick = () => { state.page = 1; renderPage(); };
        qs("#btnPrev").onclick = () => { state.page = Math.max(1, state.page - 1); renderPage(); };
        qs("#btnNext").onclick = () => { const totalPages = Math.max(1, Math.ceil(state.rows.length / state.pageSize)); state.page = Math.min(totalPages, state.page + 1); renderPage(); };
        qs("#btnLast").onclick = () => { state.page = Math.max(1, Math.ceil(state.rows.length / state.pageSize)); renderPage(); };

        /* ===== Load / Apply ===== */
        async function feedUI(obj) {
            state.data = obj;
            state.rows = mapRows(obj);
            qs("#asOf").textContent = obj.date ? obj.date : todayISO();
            qs("#sumInfo").textContent = `Toplam Lot: ${fmtQty(obj.totalQuantity)} • Toplam Tutar: ${fmtNum(obj.totalVolume, 2)} • Saat: ${obj.time || "—"}`;
            renderSummary(obj);
            state.page = 1; renderPage();
        }
        async function loadAll() {
            state.symbol = (qs("#sym").value || "{{ symbol }}").toUpperCase().replace(/[^A-Z0-9]/g, "");
            qs("#sym").value = state.symbol;
            qs("#symText").textContent = state.symbol;
            qs("#logo").src = `/logo/${encodeURIComponent(state.symbol)}`;

            // dates
            const dStart = qs("#dStart"), dEnd = qs("#dEnd"), t = todayISO();
            dStart.max = t; dEnd.max = t; if (!dStart.value) dStart.value = t; if (!dEnd.value) dEnd.value = t;
            if (dStart.value > t) dStart.value = t; if (dEnd.value > t) dEnd.value = t; if (dStart.value > dEnd.value) dEnd.value = dStart.value;

            connectMarket(state.symbol);

            const data = await fetchTakas();
            if (!data) {
                showToast("Hisse sembol adı yanlış veya veri yok");
                return;
            }
            feedUI(data);
        }
        async function applyFilters() {
            const sym = qs("#sym").value.toUpperCase().replace(/[^A-Z0-9]/g, "");
            if (!/^[A-Z0-9]{3,6}$/.test(sym)) { showModal("Hisse sembol adı yanlış"); return; }
            if (state.allSymbols.length && !state.allSymbols.includes(sym)) { showModal("Hisse sembol adı yanlış"); return; }
            state.symbol = sym;
            await loadAll();
        }

        /* ===== Events ===== */
        qs("#btnApply").onclick = applyFilters;
        qs("#btnToday").onclick = () => { const t = todayISO(); qs("#dStart").value = t; qs("#dEnd").value = t; applyFilters(); };
        qs("#btnWarn").onclick = () => showModal();
        ["#dStart", "#dEnd"].forEach(sel => {
            qs(sel).addEventListener("change", (e) => { const t = todayISO(); if (e.target.value > t) e.target.value = t; });
        });
        /* show info chip */
        qs("#chipInfo").onclick = () => showModal();

        /* ===== Init ===== */
        window.addEventListener("load", async () => {
            document.documentElement.setAttribute("data-theme", state.theme);
            qs("#symText").textContent = state.symbol;
            await loadSymbols();
            await loadAll();
        });
    </script>
</body>

</html>